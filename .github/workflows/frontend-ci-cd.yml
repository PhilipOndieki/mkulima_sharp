name: Mkulima Sharp - Frontend CI/CD

on:
  push:
    branches: [ main, master ]
    paths:
      - 'client/**'
      - '.github/workflows/frontend-ci-cd.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'client/**'

jobs:
  # Job 1: Code Quality & Linting
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      working-directory: ./client
      run: npm ci
    
    - name: ğŸ” Run ESLint
      working-directory: ./client
      run: npm run lint
    
    - name: ğŸ“ Check code formatting (optional)
      working-directory: ./client
      run: |
        echo "âœ… Code quality checks passed!"
        echo "Files checked: $(find src -type f -name '*.jsx' -o -name '*.js' | wc -l)"

  # Job 2: Build & Test
  build:
    name: Build Application
    needs: lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      working-directory: ./client
      run: npm ci
    
    - name: ğŸ—ï¸ Build production bundle
      working-directory: ./client
      run: npm run build
      env:
        # Firebase Configuration
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
        VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
    
    - name: ğŸ“Š Build statistics
      working-directory: ./client
      run: |
        echo "ğŸ“¦ Build Statistics for Mkulima Sharp:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Total build size: $(du -sh dist | cut -f1)"
        echo ""
        echo "ğŸ“ Build contents:"
        ls -lah dist
        echo ""
        echo "ğŸ¯ JavaScript bundles:"
        find dist -name '*.js' -exec du -h {} \; | sort -rh
        echo ""
        echo "âœ… Frontend build successful!"
    
    - name: ğŸ’¾ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mkulima-sharp-dist-${{ github.sha }}
        path: client/dist
        retention-days: 7

  # Job 3: Deploy to Vercel (Production)
  deploy-vercel:
    name: Deploy to Vercel
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸš€ Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./client
        vercel-args: '--prod'
    
    - name: âœ… Deployment complete
      run: |
        echo "ğŸ‰ Mkulima Sharp deployed to production!"
        echo "ğŸŒ Check your Vercel dashboard for the live URL"

  # Job 4: Deploy to Firebase Hosting (Alternative/Backup)
  deploy-firebase:
    name: Deploy to Firebase
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: mkulima-sharp-dist-${{ github.sha }}
        path: client/dist
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: ğŸ”¥ Deploy to Firebase Hosting
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        channelId: live
        projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
        entryPoint: ./client
    
    - name: âœ… Firebase deployment complete
      run: echo "ğŸ”¥ Mkulima Sharp deployed to Firebase Hosting!"

  # Job 5: Lighthouse Performance Check
  lighthouse:
    name: Performance Audit
    needs: deploy-vercel
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ” Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          ${{ secrets.VERCEL_PRODUCTION_URL }}
        uploadArtifacts: true
        temporaryPublicStorage: true
```

## Step 2: Set Up GitHub Secrets

Go to your GitHub repository â†’ Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret

Add these secrets:

### Firebase Secrets:
```
VITE_FIREBASE_API_KEY
VITE_FIREBASE_AUTH_DOMAIN
VITE_FIREBASE_PROJECT_ID
VITE_FIREBASE_STORAGE_BUCKET
VITE_FIREBASE_MESSAGING_SENDER_ID
VITE_FIREBASE_APP_ID
VITE_FIREBASE_MEASUREMENT_ID